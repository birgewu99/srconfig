- name: Commit and push changes (diagnostic, uses PAT)
  env:
    PAT: ${{ secrets.PAT_PUSH }}
    REPO: ${{ github.repository }}
    REF: ${{ github.ref }}
  run: |
    set -euo pipefail

    # 1) quick check: PAT set?
    if [ -z "${PAT:-}" ]; then
      echo "ERROR: PAT_PUSH is not set or empty. Please add it to repo secrets."
      exit 1
    fi
    # Print length only (no secret value)
    echo "PAT length: ${#PAT}"

    git config --local user.email "action@github.com"
    git config --local user.name "GitHub Action"

    echo "=== before changes: git status ==="
    git status --porcelain || true
    echo "=== staged files (before add) ==="
    git diff --name-only --cached || true

    # Stage file and show staged names
    git add output/sr_rules.conf
    echo "=== staged files (after add) ==="
    git diff --name-only --cached || true

    # If no staged changes then skip
    if git diff --cached --quiet; then
      echo "No changes detected, skipping commit and push"
      exit 0
    fi

    git commit -m "Auto: Update SR rules at $(date -u +'%Y-%m-%d %H:%M:%S')"

    # Resolve branch
    BRANCH="${REF#refs/heads/}"
    echo "Target branch: ${BRANCH}"

    # Show current origin (redact potential token if present)
    origin_url=$(git remote get-url origin || echo "")
    # redact any embedded credentials for safety
    redacted_origin=$(echo "${origin_url}" | sed -E 's#(https://)[^@]+@#\1[REDACTED]@#')
    echo "Origin (redacted): ${redacted_origin}"

    # Force set origin to use PAT (so push will use PAT)
    git remote set-url origin "https://x-access-token:${PAT}@github.com/${REPO}.git"
    # Show origin after set (redacted)
    origin_url2=$(git remote get-url origin || echo "")
    redacted_origin2=$(echo "${origin_url2}" | sed -E 's#(https://)[^@]+@#\1[REDACTED]@#')
    echo "Origin after set-url (redacted): ${redacted_origin2}"

    echo "=== git remote -v (redacted) ==="
    git remote -v | sed -E 's#(https://)[^@]+@#\1[REDACTED]@#' || true

    echo "Attempting git push..."
    # Run push and capture output (push output will reveal which account was used in remote message)
    if git push origin "HEAD:${BRANCH}"; then
      echo "Push succeeded"
      exit 0
    else
      echo "Push failed; capture last git push exit code: $?"
      # Show git ls-remote to provoke remote message
      git ls-remote origin "refs/heads/${BRANCH}" || true
      exit 1
    fi
